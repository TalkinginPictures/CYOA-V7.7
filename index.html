<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Adventure Creator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #87CEEB, #f5f5f5);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      text-align: center;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      max-width: 800px;
      width: 90%;
    }
    .options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .option {
      border: 2px solid #ccc;
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      background: #f9f9f9;
      transition: transform 0.2s ease;
    }
    .option img {
      max-width: 100%;
      border-radius: 10px;
    }
    .option:hover {
      transform: scale(1.05);
      border-color: #007bff;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    #summary-images {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    #summary-images img {
      max-width: 100px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <h1>Loading...</h1>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const app = document.getElementById("app");

    let studentName = "";
    let currentQuestionIndex = 0;
    let choices = [];

    const affirmations = [
      "Great choice!",
      "Well done!",
      "Nice pick!",
      "Excellent!",
      "Thatâ€™s a fun option!"
    ];

    const questions = [
      { text: "What will you wear on your adventure?", options: ["Knight", "Pirate", "Wizard", "Explorer", "Astronaut", "Detective", "Samurai", "Superhero", "Farmer"] },
      { text: "What will you take with you?", options: ["Sword", "Map", "Magic Wand", "Shield", "Backpack", "Torch", "Treasure Chest", "Fishing Rod", "Key"] },
      { text: "Who will join you?", options: ["Dragon", "Dog", "Cat", "Friend", "Wizard", "Giant", "Elf", "Robot", "Knight"] },
      { text: "What music will play?", options: ["Drums", "Flute", "Guitar", "Trumpet", "Piano", "Violin", "Singing", "Whistling", "Silence"] },
      { text: "Where will your adventure happen?", options: ["Forest", "Castle", "Space", "Desert", "Ocean", "Mountain", "Cave", "Jungle", "City"] },
      { text: "What challenge will you face?", options: ["Riddle", "Storm", "Monster", "Puzzle", "Maze", "River", "Volcano", "Race", "Bandits"] },
      { text: "What will you find at the end?", options: ["Treasure", "Cake", "Magic Book", "Crown", "Key", "New Friend", "Door", "Ship", "Throne"] }
    ];

    async function fetchImage(keyword) {
      try {
        // Try ARASAAC first
        let response = await fetch(`https://api.arasaac.org/api/pictograms/en/search/${keyword}`);
        let data = await response.json();
        if (data.length > 0) {
          return `https://static.arasaac.org/pictograms/${data[0]._id}/${data[0]._id}_500.png`;
        }
        // Fallback: Pixabay
        let pixabayRes = await fetch(`https://pixabay.com/api/?key=49978957-7f3f3c500656460c1f5b4026f&q=${encodeURIComponent(keyword)}&image_type=illustration&per_page=3`);
        let pixabayData = await pixabayRes.json();
        if (pixabayData.hits.length > 0) {
          return pixabayData.hits[0].webformatURL;
        }
      } catch (e) {
        console.warn("Image fetch error for:", keyword, e);
      }
      return "https://via.placeholder.com/120?text=" + keyword;
    }

    function speak(text, callback) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.onend = () => { if (callback) callback(); };
      speechSynthesis.speak(utterance);
    }

    function showNameScreen() {
      app.innerHTML = `
        <h1>Welcome to your adventure!</h1>
        <p>What is your name?</p>
        <input type="text" id="nameInput" placeholder="Type your name">
        <button onclick="startAdventure()">Start</button>
      `;
    }

    function startAdventure() {
      studentName = document.getElementById("nameInput").value || "Adventurer";
      currentQuestionIndex = 0;
      choices = [];
      showQuestion();
    }

    async function showQuestion() {
      const q = questions[currentQuestionIndex];
      app.innerHTML = `<h1>${q.text}</h1><div class="options" id="options"></div>`;
      speak(`${studentName}, ${q.text}`);
      const optionsDiv = document.getElementById("options");
      for (const opt of q.options) {
        const img = await fetchImage(opt);
        const div = document.createElement("div");
        div.className = "option";
        div.innerHTML = `<img src="${img}" alt="${opt}"><p>${opt}</p>`;
        div.onclick = () => handleChoice(opt, img);
        optionsDiv.appendChild(div);
      }
    }

    function handleChoice(choice, img) {
      choices.push({ question: questions[currentQuestionIndex].text, choice, img });
      const affirmation = affirmations[Math.floor(Math.random() * affirmations.length)];
      speak(`${affirmation}`, () => {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
          showQuestion();
        } else {
          showSummary();
        }
      });
    }

    function showSummary() {
      app.innerHTML = `<h1>Great job, ${studentName}!</h1><div id="summary-images"></div><button onclick="startAdventure()">Play Again</button><button onclick="downloadPDF()">Download Story</button>`;
      const summaryImagesDiv = document.getElementById("summary-images");
      let storyText = `${studentName}, here is your adventure:\n\n`;
      choices.forEach(c => {
        storyText += `${c.question} You chose: ${c.choice}.\n`;
        const imgEl = document.createElement("img");
        imgEl.src = c.img;
        summaryImagesDiv.appendChild(imgEl);
      });
      speak(`${studentName}, here is your story!`);
      window.generatedStoryText = storyText;
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text(window.generatedStoryText, 10, 10);
      doc.save("adventure.pdf");
    }

    showNameScreen();
  </script>
</body>
</html>
