<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Adventure Builder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #87ceeb, #ffffff);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      text-align: center;
    }
    #game-container {
      max-width: 700px;
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .option {
      margin: 10px;
      cursor: pointer;
      display: inline-block;
      padding: 10px;
      border-radius: 12px;
      border: 2px solid #ccc;
      transition: 0.2s;
      width: 150px;
      text-align: center;
      vertical-align: top;
    }
    .option img {
      max-width: 100%;
      height: 100px;
      object-fit: contain;
      display: block;
      margin: 0 auto 5px;
    }
    .option:hover {
      background: #f0f8ff;
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h2 id="question">Loading...</h2>
    <div id="options"></div>
  </div>

  <script>
    const pixabayKey = "49978957-7f3f3c500656460c1f5b4026f";
    const questions = [
      { text: "What is your name?", type: "input" },
      { text: "What will you wear on your adventure?", 
        options: ["Knight Armour", "Pirate Outfit", "Wizard Robe", "Ninja Suit", "Space Suit", "Explorer Gear", "Royal Clothes", "Superhero Costume", "Pajamas"], 
        category: "Clothing", 
        withImages: true }
    ];

    const results = [];
    let currentQuestion = 0;
    let studentName = "";

    async function fetchImage(query) {
      // Try ARASAAC first
      try {
        const arasaacRes = await fetch(`https://api.arasaac.org/api/pictograms/en/search/${encodeURIComponent(query)}`);
        const arasaacData = await arasaacRes.json();
        if (arasaacData.length > 0) {
          return `https://static.arasaac.org/pictograms/${arasaacData[0]._id}/${arasaacData[0]._id}_500.png`;
        }
      } catch (e) {
        console.warn("ARASAAC fetch failed for", query, e);
      }

      // Fallback: Pixabay
      try {
        const pixabayRes = await fetch(`https://pixabay.com/api/?key=${pixabayKey}&q=${encodeURIComponent(query)}&image_type=illustration&per_page=3`);
        const pixabayData = await pixabayRes.json();
        if (pixabayData.hits && pixabayData.hits.length > 0) {
          return pixabayData.hits[0].webformatURL;
        }
      } catch (e) {
        console.warn("Pixabay fetch failed for", query, e);
      }

      return null; // No image found
    }

    function speak(text, callback) {
      try {
        const synth = window.speechSynthesis;
        if (!synth) {
          console.warn("Speech synthesis not supported");
          if (callback) callback();
          return;
        }
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.onend = () => callback && callback();
        synth.speak(utterance);
      } catch (e) {
        console.warn("Speech error:", e);
        if (callback) callback();
      }
    }

    async function loadQuestion() {
      const q = questions[currentQuestion];
      const questionEl = document.getElementById("question");
      const optionsEl = document.getElementById("options");
      optionsEl.innerHTML = "";

      if (!q) return;

      if (q.type === "input") {
        questionEl.textContent = q.text;
        const input = document.createElement("input");
        input.placeholder = "Type your name here";
        const btn = document.createElement("button");
        btn.textContent = "Start";
        btn.onclick = () => {
          studentName = input.value.trim() || "Adventurer";
          speak(`Welcome ${studentName}! Let's begin your adventure!`, () => {
            currentQuestion++;
            loadQuestion();
          });
        };
        optionsEl.appendChild(input);
        optionsEl.appendChild(btn);
      } else {
        questionEl.textContent = q.text;
        speak(q.text);
        if (q.withImages) {
          for (const option of q.options) {
            const imgUrl = await fetchImage(option);
            const div = document.createElement("div");
            div.className = "option";
            div.innerHTML = imgUrl 
              ? `<img src="${imgUrl}" alt="${option}"><div>${option}</div>` 
              : `<div style="height:100px;display:flex;align-items:center;justify-content:center;">‚ùì</div><div>${option}</div>`;
            div.onclick = () => handleChoice(option, imgUrl);
            optionsEl.appendChild(div);
          }
        } else {
          q.options.forEach(option => {
            const div = document.createElement("div");
            div.className = "option";
            div.textContent = option;
            div.onclick = () => handleChoice(option, null);
            optionsEl.appendChild(div);
          });
        }
      }
    }

    function handleChoice(choice, imgUrl) {
      results.push({ category: questions[currentQuestion].category, choice, imgUrl });
      const affirmations = [
        `Great choice, ${studentName}!`,
        `Well done ${studentName}, let's keep going!`,
        `Awesome pick, ${studentName}!`,
        `Nice one! Ready for the next challenge?`
      ];
      const message = affirmations[Math.floor(Math.random() * affirmations.length)];
      speak(message, () => {
        currentQuestion++;
        loadQuestion();
      });
    }

    window.onload = loadQuestion;
  </script>
</body>
</html>
